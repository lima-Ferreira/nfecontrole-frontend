<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
    <title>Resultado da Comparação</title>
    <link rel="stylesheet" href="css/style.css" />
</head>

<body>
    <header class="header">
        <a href="home.html" class="back-link">
            <i class="fas fa-arrow-left"></i> Voltar para Upload
        </a>
        <h1>Notas Fiscais Faltando nas Entradas</h1>
        <div id="download-link-container"></div>
    </header>

    <main class="main">
        <section class="results" style="width: 100%;">
            <div id="results-container"></div>
        </section>
    </main>

    <script>
        const backendUrl = "https://nfecontrole-backend.onrender.com"; // URL do backend
        const chavesFaltando = JSON.parse(localStorage.getItem("chavesFaltando") || "[]");
        const resultsContainer = document.getElementById("results-container");
        const downloadContainer = document.getElementById("download-link-container");

        // Monta a tabela de resultados
        if (chavesFaltando.length > 0) {
            let tableHTML = `<table class="table"><thead>
                <tr>
                    <th>Data</th>
                    <th>UF</th>
                    <th>Documento</th>
                    <th>Chave</th>
                    <th>Fornecedor</th>
                    <th>Situação</th>
                    <th>Valor</th>
                </tr>
            </thead><tbody>`;

            chavesFaltando.forEach(item => {
                const cancelado = item.autorizacao?.toLowerCase() === "cancelado";
                tableHTML += `<tr class="${cancelado ? "linha-cancelada" : ""}">
                    <td>${item.dataTempo || ""}</td>
                    <td>${item.uf || ""}</td>
                    <td>${item.numDoc || ""}</td>
                    <td>${item.chave || ""}</td>
                    <td>${item.fornecedor || ""}</td>
                    <td>${item.autorizacao || ""}</td>
                    <td>${item.valorDoDoc || ""}</td>
                </tr>`;
            });

            tableHTML += `</tbody></table>`;
            resultsContainer.innerHTML = tableHTML;

            // Cria o botão de download usando POST
            const downloadBtn = document.createElement("button");
            downloadBtn.classList.add("download-link");
            downloadBtn.innerHTML = `<i class="fas fa-download"></i> Baixar Excel`;
            downloadBtn.onclick = async () => {
                try {
                    const response = await fetch(`${backendUrl}/api/download-excel`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ chavesFaltando })
                    });

                    if (!response.ok) {
                        throw new Error("Erro ao gerar Excel.");
                    }

                    const blob = await response.blob();
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement("a");
                    a.href = url;
                    a.download = "chaves_faltando.xlsx";
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                } catch (err) {
                    alert(err.message);
                    console.error(err);
                }
            };

            downloadContainer.appendChild(downloadBtn);

        } else {
            resultsContainer.innerHTML = "<p>Nenhuma diferença encontrada. Todas as chaves do Excel estão no PDF.</p>";
        }
    </script>
</body>

</html>